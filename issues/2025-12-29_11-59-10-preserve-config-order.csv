"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"PCO-010","P0","1","backend","复现并定界配置块重排","用最小样例复现并确认切换配置导致 Codex TOML table/Claude-Gemini JSON key 相对顺序变化，明确受影响范围与期望保持不变的块。","提供可复现样例：切换前后对比中 `[sandbox_workspace_write]` 与 `[model_providers]` 相对顺序不变（当前为会变）；同时给出 Claude/Gemini settings.json 的 key 顺序变动对比与复现步骤。","AUTOSERVER","确认复现样例覆盖：TOML 含多 table/注释/空行；JSON 含未知字段；不引入破坏性写入逻辑。","复现步骤在 Linux/macOS/Windows（至少模拟 Windows 路径/换行）可执行；文档化输入/输出对比可复查。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:16;plan/2025-12-29_11-53-30-preserve-config-order.md:17;internal/config/switch.go:133;internal/config/gemini.go:268;docs/preserve-config-order-repro.md:1;test/repro/preserve_config_order/main.go:1","picked_reason:P0 且是后续 patch/测试问题的前置——先用最小样例把“顺序变化”复现与范围钉死; evidence:go run ./test/repro/preserve_config_order 输出显示 TOML table 顺序与 Claude/Gemini JSON key 顺序发生变化; scope:codex [sandbox_workspace_write] 与 [model_providers] 相对顺序会变化；claude 顶层 key 顺序会变化；gemini 顶层 key 顺序会变化且未知字段会丢失; done_at:2025-12-29"
"PCO-020","P0","2","backend","Codex TOML 就地 patch 写入","改造 Codex `config.toml` 写入逻辑：避免 map 合并后全量 Marshal 重写，改为在原始 TOML 上只更新受管 key/value 的字节区间，保留未受管 table 的顺序/注释/空白。","在含 `[sandbox_workspace_write]` 与 `[model_providers]` 的样例中，切换后文件中未受管块的相对位置、注释与空白保持不变；仅受管字段值发生变化；解析后语义仍正确（toml.Unmarshal 不报错）。","AUTOSERVER","实现需明确“仅替换 value 区间”的策略与边界；对无效 TOML 的回退策略不应引入重排；保持原子写入。","回归覆盖：带 CRLF/LF；带注释的 key/value；多层 table；并确认切换两次前后一致性。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:18;internal/config/switch.go:133;internal/config/switch.go:206;internal/config/codex_toml_patch.go:1;internal/config/config_test.go:1378","picked_reason:P0 且直接解决 Codex 侧“顺序变化/注释丢失”的根因，后续 Claude/Gemini 与测试都依赖此模式; evidence:go test ./... 覆盖 preserve unmanaged blocks 用例；go run ./test/repro/preserve_config_order 显示 Codex table 顺序保持不变; done_at:2025-12-29"
"PCO-030","P0","3","backend","Codex 受管字段与插入策略收敛","把 Codex 的“受管字段列表/规则”集中管理，并定义当受管字段缺失时的插入位置策略（避免插入导致块位移/重排）。","受管字段清单可在单处查阅；缺失字段插入后仍满足块相对顺序不变；新增/缺失字段场景有测试覆盖并通过。","AUTOSERVER","明确哪些 key 由 CCS 管理、哪些必须保持原样；插入策略需可预测且文档化；避免隐式覆盖非受管字段。","回归验证：旧配置缺少部分字段时切换不会大幅改写文件结构；配置可读可回滚。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:19;internal/config/switch.go:206;internal/config/codex_toml_patch.go:1;docs/codex-config-toml-managed-fields.md:1;internal/config/config_test.go:1415","picked_reason:P0，当前已实现 patch，但需要把“受管范围/插入策略”文档化并加用例，避免后续扩展时隐式改变行为; evidence:docs/codex-config-toml-managed-fields.md 明确受管范围与插入策略；go test ./... 覆盖缺失字段插入与顺序保持; done_at:2025-12-29"
"PCO-040","P0","4","backend","Claude settings.json 最小化 patch 写入","改造 `writeClaudeConfig`：避免整体 MarshalIndent 导致 key 顺序变化，改为只 patch 受管字段（例如 env.* 与 model），保持其他字段原有顺序与格式尽量不变。","切换后 `settings.json` 中未受管顶层 key 的相对顺序不变；仅 env/model 等受管字段变化；JSON 仍可被解析且未知字段不丢失。","AUTOSERVER","确认 patch 逻辑不触碰未知字段；保留文件权限与原子写入；对无效 JSON 的处理策略明确。","回归：覆盖含 statusLine/extra/未知字段的真实样例；多次切换不产生格式漂移（不应逐次变动无关部分）。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:20;internal/config/switch.go:61;internal/config/types.go:153;internal/config/json_patch.go:1;internal/config/config_test.go:1569","picked_reason:P0，Claude settings.json 当前每次写回都会 key 重排；先把 Claude 改为最小 patch，给 Gemini/公共工具留模式参考; evidence:go test ./... 新增 TestWriteClaudeConfigPreservesTopLevelKeyOrder；go run ./test/repro/preserve_config_order 显示 Claude 顶层 key 顺序不变; done_at:2025-12-29"
"PCO-050","P0","5","backend","Gemini settings.json 最小化 patch 写入","改造 `writeGeminiSettingsFile`：只 patch `security.auth.selectedType`，保留 `mcpServers` 与未知字段的相对位置与内容。","切换后 `settings.json` 中 `mcpServers` 与其他未知字段不变；仅 `security.auth.selectedType` 按目标 provider 更新；JSON 可解析。","AUTOSERVER","patch 逻辑需避免整体 Marshal；保持原子写入与权限；对无效 JSON 的回退策略不应造成无关字段漂移。","回归：覆盖已有 MCPServers/Extra 的样例；多次切换输出稳定。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:21;internal/config/gemini.go:268;internal/config/types.go:235;internal/config/json_patch.go:1;internal/config/config_test.go:1672","picked_reason:P0，Gemini settings.json 目前会丢未知字段且 key 重排；复用 Claude 的最小 patch 思路把写回副作用消掉; evidence:go test ./... 新增 TestWriteGeminiSettingsPreservesTopLevelKeyOrder；go run ./test/repro/preserve_config_order 显示 Gemini 顶层 key 顺序与未知字段均保持; done_at:2025-12-29"
"PCO-060","P1","6","backend","抽象 JSON/TOML patch 公共工具","在 `internal/utils` 提供可复用的 JSON/TOML patch 工具函数，统一处理读取/（可选）校验/最小更新/原子写入，减少三处写入逻辑分叉。","三处写入（Codex/Claude/Gemini）均调用公共工具；公共工具有单测或被上层测试覆盖；失败回退行为一致且可预期。","AUTOSERVER","保持 KISS：不引入过度抽象；对外暴露 API 清晰；错误包装含上下文；不改变现有权限/路径逻辑。","回归：`go test ./...` 通过；无额外依赖；覆盖至少一个失败回退路径。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:22;internal/utils/file.go:18;internal/utils/json_patch.go:1;internal/utils/codex_toml_patch.go:1;internal/config/switch.go:61;internal/config/gemini.go:268","picked_reason:已实现三端 patch，但逻辑分散在 internal/config；按要求收敛到 internal/utils 并统一调用，降低后续维护成本; evidence:Codex/Claude/Gemini 均改为调用 internal/utils 的 patch 工具；go test ./... 通过; done_at:2025-12-29"
"PCO-070","P0","7","backend","新增“顺序不变”测试用例","补充测试，验证写回内容的相对顺序不变（而非仅语义正确），并覆盖 Codex/Claude/Gemini 的关键场景。","新增测试断言：Codex 输出中 `[sandbox_workspace_write]` 的 index < `[model_providers]`；Claude/Gemini 输出中未受管 key 的相对顺序不变；测试在本机 `go test ./...` 通过。","AUTOSERVER","测试应稳定（不依赖时间/随机）；断言关注相对顺序与最小变更；同时保留对语义解析的校验。","回归：在切换两次/三次后输出仍稳定；测试覆盖无效输入回退路径（至少一个）。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:23;plan/2025-12-29_11-53-30-preserve-config-order.md:24;plan/2025-12-29_11-53-30-preserve-config-order.md:25;internal/config/config_test.go:1348;internal/config/config_test.go:1380;internal/config/config_test.go:1571;internal/config/config_test.go:1672","picked_reason:P0，关键“顺序不变”断言已在前置实现中补齐；此处补全 refs/状态并闭环提交; evidence:go test ./... 通过；Codex/Claude/Gemini 的“顺序不变”断言均已覆盖; done_at:2025-12-29"
"PCO-080","P1","8","backend","全量回归与评审闭环","按仓库规范执行格式化、单测、编译，并组织一次代码评审，确保修复不引入兼容性/写入行为变化。","`go fmt ./...`、`go test ./...`、`go build` 全通过；评审清单包含：受管字段边界、回退策略、跨平台换行/权限；评审意见已闭环（有记录）。","AUTOSERVER","Review 重点：不改变 CLI 行为；写入失败可回滚/报错清晰；不引入破坏性文件操作；保持向后兼容。","回归重点：对真实配置样例做切换前后 diff，确认仅目标字段变更；并在 Windows 路径/权限场景下验证。","已完成","已完成","已完成","已提交","","plan/2025-12-29_11-53-30-preserve-config-order.md:26;plan/2025-12-29_11-53-30-preserve-config-order.md:33;docs/reviews/2025-12-29_preserve-config-order-review.md:1;internal/utils/codex_toml_patch.go:1;internal/utils/json_patch.go:1","picked_reason:最后一条收尾任务：跑全量 fmt/test/build 并落盘一次 review 记录，确保闭环可追溯; evidence:go fmt ./... + go test ./... + go build 通过；review_record:docs/reviews/2025-12-29_preserve-config-order-review.md; done_at:2025-12-29"
