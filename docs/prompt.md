# TUI 模板管理功能实现需求文档

> 本文档描述 cc-switch-cli TUI 模式中模板管理功能的实现需求
> 创建日期: 2025-10-15

## 功能概述

为 TUI 交互界面添加完整的 CLAUDE.md 模板管理功能，允许用户在终端界面中：
- 浏览和选择预定义/用户自定义模板
- 预览模板内容和 diff 差异
- 应用模板到三个目标路径
- 保存当前配置为新模板
- 管理用户自定义模板

## 当前状态

### 已完成（CLI 部分）
- ✅ `internal/template/` 模板管理核心逻辑
- ✅ `cmd/template_*.go` 完整的 CLI 命令
- ✅ 预定义模板（3个）：linus、gentle-assistant、code-reviewer
- ✅ 用户模板 CRUD 功能
- ✅ Diff 工具集成
- ✅ 原子写入和备份机制

### 待实现（TUI 部分）
- ⏳ TUI 模板管理界面
- ⏳ 交互式模板选择和应用
- ⏳ Diff 预览界面
- ⏳ 模板保存和删除界面

## TUI 界面设计需求

### 1. 主菜单扩展

**新增快捷键**
- 在现有 TUI 列表模式（`mode: "list"`）中添加快捷键 `m` 进入模板管理
- 帮助文本区域新增：`m: 模板管理`

**入口逻辑**
- 按 `m` 键后：
  - 模式切换为 `mode: "template_manager"`
  - 加载所有模板（预定义 + 用户自定义）
  - 光标默认在第一个模板
  - 显示模板管理界面

---

### 2. 模板管理主界面

**界面模式**: `mode: "template_manager"`

#### 视觉布局

```
┌─ 模板管理 ────────────────────────────┐
│                                        │
│  预定义模板:                           │
│    → Linus                   (linus)   │
│      Gentle Assistant   (gentle-...)   │
│      Code Reviewer      (code-rev...)  │
│                                        │
│  ─────────────────────────────────────  │
│                                        │
│  用户模板:                             │
│      我的配置1           (user_123...)  │
│      备份_20251015       (user_456...)  │
│                                        │
│  (共 5 个模板)                         │
│                                        │
│  ↑/↓: 选择 • Enter: 应用 • p: 预览    │
│  s: 保存 • d: 删除 • ESC: 返回        │
└────────────────────────────────────────┘
```

#### 显示内容

**预定义模板区域**
- 标题："预定义模板:"（灰色）
- 每行显示：
  - 选中标记（`→` 或 空格）
  - 模板名称（粗体）
  - 模板 ID（灰色小字，截断显示）
- 预定义模板不显示删除选项

**用户模板区域**
- 分隔线
- 标题："用户模板:"（灰色）
- 显示格式同预定义模板
- 如果没有用户模板，显示 "（暂无用户模板）"

**统计信息**
- 底部显示总模板数

#### 快捷键操作

| 按键 | 功能 | 说明 |
|------|------|------|
| `↑` 或 `k` | 上移光标 | 跨区域移动（预定义→用户） |
| `↓` 或 `j` | 下移光标 | 跨区域移动 |
| `Enter` | 应用模板 | 进入目标路径选择界面 |
| `p` | 预览模板 | 只读查看模板完整内容 |
| `s` | 保存为模板 | 进入源路径选择界面 |
| `d` | 删除模板 | 仅用户模板可删除，预定义禁止 |
| `r` | 刷新列表 | 重新加载模板列表 |
| `ESC` 或 `q` | 返回主菜单 | 回到 Provider 列表 |

#### 错误处理

- 在预定义模板上按 `d`：显示红色错误 "✗ 预定义模板无法删除"
- 模板加载失败：显示错误信息和重试提示

---

### 3. 应用模板流程

**界面模式**: `mode: "template_apply"`

#### 3.1 目标路径选择界面

```
┌─ 应用模板: Linus ─────────────────────┐
│                                        │
│  选择目标路径:                         │
│                                        │
│  → [✓] ./CLAUDE.md                     │
│         项目根目录配置                 │
│                                        │
│    [✗] ~/.claude/CLAUDE.md             │
│         全局 Claude 配置               │
│                                        │
│    [✗] ./CLAUDE.local.md               │
│         项目本地配置（Git 忽略）       │
│                                        │
│  ↑/↓: 选择 • Enter: 下一步 • ESC: 取消│
└────────────────────────────────────────┘
```

**显示内容**
- 标题显示：当前选中的模板名称
- 三个目标路径选项：
  1. `./CLAUDE.md` - 项目根目录配置
  2. `~/.claude/CLAUDE.md` - 全局 Claude 配置
  3. `./CLAUDE.local.md` - 项目本地配置

**文件存在标记**
- `[✓]`：文件已存在（绿色）
- `[✗]`：文件不存在（灰色）

**快捷键**
- `↑/↓`：选择目标路径
- `Enter`：确认选择，进入 Diff 预览
- `ESC`：取消，返回模板列表

#### 3.2 Diff 预览界面

```
┌─ Diff 预览 ───────────────────────────┐
│                                        │
│  模板: Linus                           │
│  目标: ./CLAUDE.md                     │
│                                        │
│  --- 当前文件                          │
│  +++ 模板: Linus                       │
│  @@ -1,5 +1,10 @@                     │
│  -# CLAUDE.md                         │
│  +## 角色定义                         │
│  +                                     │
│  +你是 Linus Torvalds...              │
│  (向下滚动查看更多...)                 │
│                                        │
│  ⚠ 即将覆盖目标文件                   │
│  备份将保存为: CLAUDE.md.bak.202510...│
│                                        │
│  y: 应用 • n: 取消 • ↑/↓: 滚动        │
└────────────────────────────────────────┘
```

**两种情况**

**情况A：目标文件不存在**
- 显示 "✓ 目标文件不存在，将创建新文件"
- 显示模板内容预览（前 20 行）
- 不显示 diff，直接显示 "无需备份"

**情况B：目标文件存在**
- 调用 `TemplateManager.GetDiff()` 生成 unified diff
- 彩色显示 diff：
  - 红色：删除的行（`-` 开头）
  - 绿色：新增的行（`+` 开头）
  - 青色：位置标记（`@@` 开头）
  - 粗体：文件头（`---` 和 `+++`）
- 显示备份文件名预览

**确认提示**
- 警告："⚠ 即将覆盖目标文件"
- 显示备份文件格式示例

**快捷键**
- `↑/↓`：滚动查看 diff（如果内容超过屏幕高度）
- `y` 或 `Y`：确认应用模板
- `n` 或 `N` 或 `ESC`：取消操作

#### 3.3 应用结果反馈

**成功**
```
✓ 模板已成功应用到: ./CLAUDE.md
✓ 备份已创建: ./CLAUDE.md.bak.20251015_153042
```
- 绿色勾号 + 成功消息
- 显示目标路径
- 显示备份文件完整路径
- 2 秒后自动返回模板列表

**失败**
```
✗ 应用模板失败: 权限不足
请使用 sudo 或检查文件权限
```
- 红色叉号 + 错误信息
- 显示详细错误原因
- 给出解决建议
- 按任意键返回模板列表

---

### 4. 保存为模板流程

**界面模式**: `mode: "template_save"`

#### 4.1 源路径选择界面

```
┌─ 保存为模板 ──────────────────────────┐
│                                        │
│  选择源文件:                           │
│                                        │
│  → [✓] ./CLAUDE.md                     │
│         项目根目录配置                 │
│                                        │
│    [✗] ~/.claude/CLAUDE.md             │
│         全局 Claude 配置               │
│                                        │
│    [✓] ./CLAUDE.local.md               │
│         项目本地配置                   │
│                                        │
│  只能选择已存在的文件                  │
│  ↑/↓: 选择 • Enter: 下一步 • ESC: 取消│
└────────────────────────────────────────┘
```

**显示内容**
- 同应用模板的目标路径选择
- 增加提示："只能选择已存在的文件"
- 不存在的文件置灰且无法选择

**快捷键**
- `↑/↓`：在已存在的文件间移动
- `Enter`：确认选择，进入命名表单
- `ESC`：取消，返回模板列表

**文件不存在处理**
- 如果当前光标在不存在的文件上按 `Enter`
- 显示错误："✗ 该文件不存在，无法保存"
- 不进入下一步

#### 4.2 命名表单界面

```
┌─ 保存为模板 ──────────────────────────┐
│                                        │
│  源文件: ./CLAUDE.md                   │
│                                        │
│  模板名称:                             │
│  ┌────────────────────────────────────┐│
│  │ 我的配置1_                         ││
│  └────────────────────────────────────┘│
│                                        │
│  留空将使用默认名称: "用户配置1"      │
│                                        │
│  Enter: 保存 • ESC: 取消               │
└────────────────────────────────────────┘
```

**输入框**
- 单个文本输入框：模板名称
- 默认值：使用 `GenerateDefaultTemplateName()` 生成
  - "用户配置1"、"用户配置2"...（自动避免重名）
- Placeholder: "输入模板名称（留空使用默认）"
- 最大长度：50 字符

**快捷键**
- 输入文本：正常输入
- `Enter`：确认保存
- `ESC`：取消，返回模板列表

#### 4.3 保存结果反馈

**成功**
```
✓ 模板已保存
  ID: user_1729012345678
  名称: 我的配置1
  类型: claude_md
```
- 绿色勾号 + 成功消息
- 显示生成的模板 ID
- 显示用户输入的名称
- 显示类别
- 自动返回模板列表并刷新，高亮新模板

**失败**
```
✗ 保存失败: 读取文件失败
请检查文件权限
```
- 红色叉号 + 错误信息
- 按任意键返回模板列表

---

### 5. 预览模板界面

**界面模式**: `mode: "template_preview"`

```
┌─ 预览: Linus ─────────────────────────┐
│  ID: linus                             │
│  类型: claude_md                       │
│  预定义模板                            │
│                                        │
│  ──────────────────────────────────────│
│                                        │
│  ## 角色定义                           │
│                                        │
│  你是 Linus Torvalds，Linux 内核的... │
│                                        │
│  ##  我的核心哲学                      │
│                                        │
│  **1. "好品味"(Good Taste) - 我的...  │
│  (向下滚动查看更多...)                 │
│                                        │
│  ↑/↓: 滚动 • ESC: 返回                │
└────────────────────────────────────────┘
```

**显示内容**
- 标题：模板名称
- 元信息：
  - ID
  - 类别（category）
  - 类型标记（预定义/用户自定义）
- 分隔线
- 模板完整内容（只读）

**滚动功能**
- 如果内容超过屏幕高度，支持上下滚动
- 显示滚动提示："(向下滚动查看更多...)"

**快捷键**
- `↑/↓` 或 `j/k`：滚动内容
- `ESC` 或 `q`：返回模板列表

---

### 6. 删除模板界面

**界面模式**: `mode: "template_delete"`

```
┌─ 确认删除 ────────────────────────────┐
│                                        │
│  确定要删除模板吗？                    │
│                                        │
│  名称: 我的配置1                       │
│  ID: user_1729012345678                │
│  类型: claude_md                       │
│                                        │
│  ⚠ 此操作无法撤销！                   │
│                                        │
│  y: 删除 • n: 取消                     │
└────────────────────────────────────────┘
```

**显示内容**
- 标题："确认删除"
- 要删除的模板信息：
  - 名称
  - ID
  - 类别
- 警告文字："⚠ 此操作无法撤销！"（红色粗体）

**快捷键**
- `y` 或 `Y`：确认删除
- `n` 或 `N` 或 `ESC`：取消

**删除结果**

成功：
```
✓ 模板已删除: 我的配置1
```
- 返回模板列表并刷新

失败：
```
✗ 删除失败: 无法写入配置文件
```
- 显示错误信息
- 按任意键返回模板列表

---

## 数据结构设计

### TUI Model 扩展

需要在现有 `internal/tui/tui.go` 的 `Model` 结构中添加以下字段：

```go
type Model struct {
    // ... 现有字段（manager, providers, cursor 等）...

    // 模板管理相关字段
    templateManager     *template.TemplateManager  // 模板管理器实例
    templates           []template.Template        // 当前显示的模板列表
    templateCursor      int                        // 模板列表光标位置
    templateMode        string                     // 模板子模式状态机

    // 应用模板流程
    selectedTemplate    *template.Template         // 当前选中的模板
    targetSelectCursor  int                        // 目标路径选择光标（0-2）
    selectedTargetPath  string                     // 选中的目标路径（绝对路径）
    diffContent         string                     // 生成的 diff 内容
    diffScrollOffset    int                        // diff 查看滚动偏移量

    // 保存模板流程
    sourceSelectCursor  int                        // 源路径选择光标（0-2）
    selectedSourcePath  string                     // 选中的源路径
    saveNameInput       textinput.Model            // 模板名称输入框

    // 预览流程
    previewScrollOffset int                        // 预览内容滚动偏移量
}
```

### 模板子模式状态机

`templateMode` 字段的可能值：

| 值 | 说明 | 对应界面 |
|----|------|----------|
| `""` | 未进入模板管理 | - |
| `"list"` | 模板列表 | 主界面 |
| `"apply_select_target"` | 应用-选择目标 | 目标路径选择 |
| `"apply_preview_diff"` | 应用-预览diff | Diff 预览 |
| `"save_select_source"` | 保存-选择源 | 源路径选择 |
| `"save_input_name"` | 保存-输入名称 | 命名表单 |
| `"preview"` | 预览模板 | 预览界面 |
| `"delete_confirm"` | 删除确认 | 删除确认 |

---

## 实现关键点

### 1. 模板管理器初始化

**时机**
- 在 TUI 启动时（`New()` 函数）创建 `TemplateManager` 实例
- 配置路径：`~/.cc-switch/claude_templates.json`

**初始化逻辑**
```
1. 获取用户配置目录
2. 拼接模板配置文件路径
3. 调用 template.NewTemplateManager(configPath)
4. 自动加载预定义模板（embed.FS）
5. 自动加载用户模板（如果文件存在）
6. 如果加载失败，显示错误但不阻止 TUI 启动
```

### 2. 错误处理规范

**预定义模板删除**
- 检测：`template.IsBuiltin == true`
- 拦截：在按 `d` 时检查
- 提示：红色错误消息 "✗ 预定义模板无法删除"

**文件权限错误**
- 应用模板时目标文件不可写
- 保存模板时源文件不可读
- 提示：具体错误 + 解决建议（如 "请检查文件权限"）

**模板不存在**
- 用户手动删除了配置文件
- 列表中的模板 ID 无效
- 提示："模板不存在，请刷新列表"

**Diff 生成失败**
- 通常不应失败（内部错误）
- 提示错误信息
- 允许用户选择：强制应用 或 取消

### 3. 用户体验优化

**应用模板前必须预览**
- 不允许跳过 diff 预览步骤
- 即使目标文件不存在，也显示模板内容预览
- 让用户明确知道即将写入的内容

**自动创建备份**
- 调用 `TemplateManager.ApplyTemplate()` 自动备份
- 备份命名格式：`{文件名}.bak.{时间戳}`
- 显示备份文件完整路径

**操作反馈清晰**
- 成功：绿色 ✓ + 详细信息
- 失败：红色 ✗ + 错误原因 + 解决建议
- 进度提示：如 "正在应用模板..."

**键盘导航流畅**
- 支持 `↑/↓` 和 `j/k` 两套键位
- 长内容自动支持滚动
- `ESC` 总是返回上一级

### 4. 视觉设计一致性

**颜色方案**（与现有 TUI 保持一致）
- 蓝色 (#007AFF)：标题、高亮、按钮
- 绿色 (#34C759)：成功消息、活动标记
- 红色 (#FF3B30)：错误消息、警告、删除
- 灰色 (#8E8E93)：帮助文本、次要信息
- 青色：Diff 位置标记

**布局样式**
- 使用 `lipgloss` 库统一样式
- 边框：圆角边框（`lipgloss.RoundedBorder()`）
- 内边距：标题 `Padding(0, 1)`，内容 `Padding(1, 2)`
- 列表项：光标选中时蓝色背景 + 白色文字

**文本截断**
- 模板 ID 过长时截断显示（如 `user_123...`）
- 路径过长时使用 `~` 替代用户目录
- Diff 内容每行最大宽度适配终端

### 5. 性能考虑

**模板列表缓存**
- 进入模板管理时加载一次
- 仅在以下情况刷新：
  - 用户按 `r` 手动刷新
  - 完成添加/删除操作后

**Diff 按需生成**
- 仅在进入预览界面时生成 diff
- 缓存在 `diffContent` 字段
- 切换目标路径时重新生成

**滚动优化**
- 只渲染可见区域 + 缓冲区
- 大文件预览时使用虚拟滚动
- 避免全文内容一次性加载到内存

---

## 实现文件规划

建议的文件组织结构：

```
internal/tui/
├── tui.go                      # 现有：主 Model 和 Update/View 入口
│                               # 修改：添加 template_manager 模式分支
│
├── template_manager.go         # 新增：模板管理主视图
│   ├── viewTemplateList()     # 渲染模板列表
│   ├── handleTemplateListKeys() # 处理列表快捷键
│   └── refreshTemplates()     # 刷新模板列表
│
├── template_apply.go           # 新增：应用模板流程
│   ├── viewTargetSelect()     # 渲染目标路径选择
│   ├── viewDiffPreview()      # 渲染 diff 预览
│   ├── handleTargetSelectKeys() # 处理目标选择键
│   ├── handleDiffPreviewKeys()  # 处理 diff 预览键
│   └── applyTemplateToTarget()  # 执行应用操作
│
├── template_save.go            # 新增：保存为模板流程
│   ├── viewSourceSelect()     # 渲染源路径选择
│   ├── viewSaveNameInput()    # 渲染命名表单
│   ├── handleSourceSelectKeys() # 处理源选择键
│   ├── handleSaveNameKeys()   # 处理命名表单键
│   └── saveAsTemplate()       # 执行保存操作
│
├── template_preview.go         # 新增：预览模板
│   ├── viewTemplatePreview()  # 渲染预览界面
│   └── handlePreviewKeys()    # 处理预览键（滚动）
│
└── template_delete.go          # 新增：删除确认
    ├── viewTemplateDelete()   # 渲染删除确认
    ├── handleDeleteKeys()     # 处理确认键
    └── deleteTemplate()       # 执行删除操作
```

---

## 测试要点

### 功能测试

1. **模板列表**
   - [ ] 预定义模板正确加载和显示（3个）
   - [ ] 用户模板正确加载和显示
   - [ ] 空用户模板时显示提示
   - [ ] 分组显示正确（预定义/用户）
   - [ ] 光标可以跨区域移动

2. **应用模板**
   - [ ] 目标路径选择正确显示文件存在状态
   - [ ] 目标文件存在时 diff 预览准确
   - [ ] 目标文件不存在时显示新建提示
   - [ ] 应用成功后正确创建备份
   - [ ] 应用失败时显示详细错误
   - [ ] 备份文件路径显示正确

3. **保存模板**
   - [ ] 源路径选择只显示已存在文件
   - [ ] 不存在的文件无法选择
   - [ ] 默认名称自动生成且不重复
   - [ ] 保存成功后模板列表自动刷新
   - [ ] 新模板高亮显示

4. **预览模板**
   - [ ] 完整显示模板内容
   - [ ] 长内容可以滚动查看
   - [ ] 显示正确的元信息（ID、类型）

5. **删除模板**
   - [ ] 预定义模板禁止删除
   - [ ] 用户模板可以删除
   - [ ] 删除前显示确认界面
   - [ ] 删除成功后列表刷新

### 交互测试

1. **快捷键响应**
   - [ ] 所有快捷键正常工作
   - [ ] `ESC` 正确返回上一级
   - [ ] `↑/↓` 和 `j/k` 都能导航
   - [ ] 滚动功能正常

2. **错误处理**
   - [ ] 权限不足时显示清晰错误
   - [ ] 文件不存在时正确处理
   - [ ] 操作被中断时状态正确恢复

3. **用户体验**
   - [ ] 操作流程流畅无卡顿
   - [ ] 反馈信息清晰及时
   - [ ] 视觉样式与现有 TUI 一致

---

## 注意事项

1. **不要破坏现有功能**
   - 模板管理完全独立于 Provider 管理
   - 不影响现有的 TUI 切换流程
   - 保持现有快捷键不变

2. **保持代码简洁**
   - 遵循 Linus 的"好品味"原则
   - 消除特殊情况分支
   - 每个函数只做一件事

3. **跨平台兼容**
   - 路径处理使用 `filepath.Join()`
   - 颜色输出在不支持时优雅降级
   - 终端大小适配（最小支持 80x24）

4. **与 CLI 保持一致**
   - 使用相同的 `TemplateManager` 实例
   - 错误消息风格一致
   - 操作结果一致（备份格式、文件权限）

5. **UTF-8 编码**
   - 所有文件读写使用 UTF-8
   - 正确处理中文内容
   - 模板名称支持中文

---

**文档版本**: v1.0
**创建日期**: 2025-10-15
**最后更新**: 2025-10-15
